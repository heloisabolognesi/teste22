{% extends "base.html" %}

{% block title %}L.A.A.R.I - {{ _('Bem-vindo') }}{% endblock %}

{% block content %}
<!-- Team Button - Top Left -->
<div class="position-absolute top-0 start-0 p-3" style="z-index: 1050;">
    <button class="btn btn-archaeological d-flex align-items-center gap-2 px-3 py-2" 
            type="button" 
            id="teamGalleryBtn"
            data-bs-toggle="modal" 
            data-bs-target="#teamGalleryModal"
            data-i18n-aria="btn_conheca_equipe">
        <i class="fas fa-users"></i>
        <span data-i18n="btn_conheca_equipe">Conhe√ßa nossa equipe</span>
    </button>
</div>

<!-- Theme and Language Controls - Top Right -->
<div class="position-absolute top-0 end-0 p-3 d-flex gap-2" style="z-index: 1050;">
    <button class="btn btn-archaeological rounded-circle d-flex align-items-center justify-content-center p-0" type="button" id="themeToggle" style="width: 45px; height: 45px; font-size: 1.3rem; line-height: 1;" data-i18n-aria="theme_toggle">
        <span id="themeIcon">üåô</span>
    </button>
    <div class="dropdown">
        <button class="btn btn-archaeological dropdown-toggle" type="button" id="languageDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fas fa-globe me-2"></i><span data-i18n="nav_idioma">Idioma</span>
        </button>
        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="languageDropdown">
            <li><a class="dropdown-item" href="#" data-language="pt-BR">
                <span class="me-2">üáßüá∑</span><span data-i18n="language_pt">Portugu√™s</span>
            </a></li>
            <li><a class="dropdown-item" href="#" data-language="en">
                <span class="me-2">üá¨üáß</span><span data-i18n="language_en">English</span>
            </a></li>
            <li><a class="dropdown-item" href="#" data-language="es">
                <span class="me-2">üá™üá∏</span><span data-i18n="language_es">Espa√±ol</span>
            </a></li>
            <li><a class="dropdown-item" href="#" data-language="fr">
                <span class="me-2">üá´üá∑</span><span data-i18n="language_fr">Fran√ßais</span>
            </a></li>
        </ul>
    </div>
</div>

<div class="position-relative">

<div class="welcome-container">
    <div class="row justify-content-center">
        <div class="col-lg-8 text-center">
            <div class="welcome-header mb-5">
                <i class="fas fa-university archaeological-icon mb-3"></i>
                <h1 class="display-4 fw-bold archaeological-title" data-i18n="app_name">L.A.A.R.I</h1>
                <h2 class="h4 mb-4 text-muted" data-i18n="app_full_name">Laborat√≥rio e Acervo Arqueol√≥gico Remoto Integrado</h2>
                <p class="lead" data-i18n="app_description">Sistema completo de gest√£o arqueol√≥gica para centralizar documenta√ß√£o, cataloga√ß√£o, acervo e invent√°rio, facilitando a comunica√ß√£o entre equipes de campo e laborat√≥rio.</p>
            </div>

            <div class="welcome-actions">
                <div class="row g-4 justify-content-center">
                    <div class="col-md-6">
                        <div class="card h-100 shadow-sm border-0 action-card">
                            <div class="card-body text-center p-4">
                                <i class="fas fa-sign-in-alt fa-3x mb-3 text-archaeological"></i>
                                <h4 class="card-title" data-i18n="login_title">Entrar</h4>
                                <p class="card-text" data-i18n="login_description">Acesse sua conta existente no sistema L.A.A.R.I</p>
                                <a href="{{ url_for('login') }}" class="btn btn-archaeological btn-lg">
                                    <i class="fas fa-arrow-right me-2"></i><span data-i18n="btn_fazer_login">Fazer Login</span>
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card h-100 shadow-sm border-0 action-card">
                            <div class="card-body text-center p-4">
                                <i class="fas fa-user-plus fa-3x mb-3 text-archaeological"></i>
                                <h4 class="card-title" data-i18n="register_title">Cadastrar</h4>
                                <p class="card-text" data-i18n="register_description">Crie uma nova conta para acessar o sistema</p>
                                <a href="{{ url_for('register') }}" class="btn btn-outline-archaeological btn-lg">
                                    <i class="fas fa-user-plus me-2"></i><span data-i18n="btn_criar_conta">Criar Conta</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Features overview -->
            <div class="features-overview mt-5">
                <h3 class="mb-4" data-i18n="features_title">Funcionalidades Principais</h3>
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="feature-item">
                            <i class="fas fa-archive fa-2x mb-2 text-archaeological"></i>
                            <h5 data-i18n="feature_acervo">Acervo Digital</h5>
                            <p class="small text-muted" data-i18n="feature_acervo_desc">Consulta organizada de todos os itens catalogados</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="feature-item">
                            <i class="fas fa-tags fa-2x mb-2 text-archaeological"></i>
                            <h5 data-i18n="feature_catalogacao">Cataloga√ß√£o</h5>
                            <p class="small text-muted" data-i18n="feature_catalogacao_desc">Sistema completo de registro de artefatos</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="feature-item">
                            <i class="fas fa-cube fa-2x mb-2 text-archaeological"></i>
                            <h5 data-i18n="feature_scanner">Scanner 3D</h5>
                            <p class="small text-muted" data-i18n="feature_scanner_desc">Integra√ß√£o com digitaliza√ß√£o 3D</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="feature-item">
                            <i class="fas fa-users fa-2x mb-2 text-archaeological"></i>
                            <h5 data-i18n="feature_profissionais">Profissionais</h5>
                            <p class="small text-muted" data-i18n="feature_profissionais_desc">Diret√≥rio de arque√≥logos da regi√£o</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="feature-item">
                            <i class="fas fa-clipboard-list fa-2x mb-2 text-archaeological"></i>
                            <h5 data-i18n="feature_inventario">Invent√°rio</h5>
                            <p class="small text-muted" data-i18n="feature_inventario_desc">Controle completo do invent√°rio</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="feature-item">
                            <i class="fas fa-truck fa-2x mb-2 text-archaeological"></i>
                            <h5 data-i18n="feature_transporte">Transporte</h5>
                            <p class="small text-muted" data-i18n="feature_transporte_desc">Rastreamento de movimenta√ß√£o</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<!-- Modal da Galeria da Equipe -->
<div class="modal fade" id="teamGalleryModal" tabindex="-1" aria-labelledby="teamGalleryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <!-- Cabe√ßalho do Modal -->
            <div class="modal-header bg-archaeological text-white">
                <div>
                    <h5 class="modal-title" id="teamGalleryModalLabel" data-i18n="galeria_modal_title">Nossa Equipe - Tech Era</h5>
                    <small class="d-block opacity-75" data-i18n="galeria_modal_desc">Conhe√ßa os membros da equipe Tech Era e nossos projetos</small>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <!-- Corpo do Modal -->
            <div class="modal-body p-4">
                <!-- Se√ß√£o Descritiva da Tech Era -->
                <div class="team-about-section mb-5">
                    <h4 class="text-archaeological mb-3" data-i18n="team_about_title">Sobre a Tech Era</h4>
                    <p class="lead" data-i18n="team_about_intro">
                        Somos a Tech Era, uma equipe apaixonada por ci√™ncia, tecnologia e rob√≥tica! 
                        Participamos da FIRST Lego League (FLL), onde aprendemos a usar a criatividade e o trabalho em equipe para transformar ideias em solu√ß√µes reais.
                    </p>
                    
                    <p class="mb-3" data-i18n="team_core_values_title">
                        Guiados pelos 6 pilares do Core Values, buscamos colocar em pr√°tica cada um deles em tudo o que fazemos:
                    </p>
                    
                    <div class="core-values-list">
                        <div class="core-value-item">
                            <span class="cv-icon"><i class="fas fa-lightbulb"></i></span>
                            <span data-i18n="team_cv_discovery">Descoberta: aprendemos algo novo a cada desafio.</span>
                        </div>
                        <div class="core-value-item">
                            <span class="cv-icon"><i class="fas fa-rocket"></i></span>
                            <span data-i18n="team_cv_innovation">Inova√ß√£o: criamos solu√ß√µes criativas e originais.</span>
                        </div>
                        <div class="core-value-item">
                            <span class="cv-icon"><i class="fas fa-globe"></i></span>
                            <span data-i18n="team_cv_impact">Impacto: usamos o que sabemos para melhorar o mundo ao nosso redor.</span>
                        </div>
                        <div class="core-value-item">
                            <span class="cv-icon"><i class="fas fa-hands-helping"></i></span>
                            <span data-i18n="team_cv_inclusion">Inclus√£o: valorizamos cada voz e respeitamos as diferen√ßas.</span>
                        </div>
                        <div class="core-value-item">
                            <span class="cv-icon"><i class="fas fa-users"></i></span>
                            <span data-i18n="team_cv_teamwork">Trabalho em equipe: colaboramos e crescemos juntos.</span>
                        </div>
                        <div class="core-value-item">
                            <span class="cv-icon"><i class="fas fa-smile"></i></span>
                            <span data-i18n="team_cv_fun">Divers√£o: celebramos cada conquista com alegria e entusiasmo!</span>
                        </div>
                    </div>
                    
                    <p class="lead text-center mt-4 mb-0 text-archaeological fw-bold" data-i18n="team_conclusion">
                        Acreditamos que a verdadeira tecnologia est√° nas pessoas ‚Äî e √© com uni√£o, curiosidade e prop√≥sito que a Tech Era constr√≥i o futuro!
                    </p>
                    
                    <hr class="my-4">
                    <h5 class="text-center mb-4">Galeria de Fotos da Equipe</h5>
                </div>
                
                <!-- √Årea de carregamento -->
                <div id="galleryLoading" class="text-center py-5">
                    <div class="spinner-border text-archaeological" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="text-muted mt-3">Carregando galeria...</p>
                </div>
                
                <!-- Grid de fotos -->
                <div id="galleryGrid" class="row g-3 d-none">
                    <!-- As fotos ser√£o carregadas dinamicamente via JavaScript -->
                </div>
                
                <!-- Estado vazio -->
                <div id="galleryEmpty" class="text-center py-5 d-none">
                    <i class="fas fa-images fa-4x text-muted mb-3"></i>
                    <h4 class="text-muted">Nenhuma foto dispon√≠vel</h4>
                    <p class="text-muted">A galeria est√° vazia no momento.</p>
                </div>
            </div>
            
            <!-- Rodap√© do Modal -->
            <div class="modal-footer border-0 bg-light">
                {% if current_user.is_authenticated and current_user.is_admin %}
                <button type="button" class="btn btn-success me-auto" id="toggleUploadFormBtn">
                    <i class="fas fa-plus me-2"></i><span>Adicionar Foto</span>
                </button>
                {% endif %}
                <button type="button" class="btn btn-archaeological" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i><span data-i18n="galeria_close">Fechar</span>
                </button>
            </div>
            
            <!-- Formul√°rio de Upload (apenas para admins) -->
            {% if current_user.is_authenticated and current_user.is_admin %}
            <div id="uploadFormContainer" class="border-top bg-white p-4 d-none">
                <h5 class="mb-3"><i class="fas fa-camera me-2"></i>Adicionar Nova Foto da Equipe</h5>
                <form id="teamPhotoUploadForm" enctype="multipart/form-data">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="photoTitle" class="form-label">T√≠tulo <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="photoTitle" name="title" required>
                        </div>
                        <div class="col-md-6">
                            <label for="photoImage" class="form-label">Imagem <span class="text-danger">*</span></label>
                            <input type="file" class="form-control" id="photoImage" name="image" accept="image/jpeg,image/png,image/gif" required>
                        </div>
                        <div class="col-12">
                            <label for="photoDescription" class="form-label">Descri√ß√£o (opcional)</label>
                            <textarea class="form-control" id="photoDescription" name="description" rows="2"></textarea>
                        </div>
                        <div class="col-12" id="imagePreviewContainer" style="display: none;">
                            <label class="form-label">Preview:</label>
                            <img id="imagePreview" src="" alt="Preview" class="img-thumbnail" style="max-height: 200px;">
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-upload me-2"></i>Enviar Foto
                            </button>
                            <button type="button" class="btn btn-secondary" id="cancelUploadBtn">
                                <i class="fas fa-times me-2"></i>Cancelar
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal para visualiza√ß√£o de foto individual -->
<div class="modal fade" id="photoViewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content bg-transparent border-0">
            <div class="modal-header border-0">
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0 text-center">
                <img id="photoViewImage" src="" class="img-fluid rounded" alt="" style="max-height: 85vh; object-fit: contain;">
            </div>
            <div id="photoViewInfo" class="modal-footer border-0 bg-white bg-opacity-90">
                <div class="w-100">
                    <h5 id="photoViewTitle" class="mb-2"></h5>
                    <p id="photoViewDescription" class="text-muted mb-0"></p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
/**
 * Script para carregar e exibir a galeria da equipe no modal
 * Carrega fotos dinamicamente da API e permite visualiza√ß√£o em tela cheia
 */
(function() {
    'use strict';
    
    // Elementos do DOM
    const teamGalleryModal = document.getElementById('teamGalleryModal');
    const galleryLoading = document.getElementById('galleryLoading');
    const galleryGrid = document.getElementById('galleryGrid');
    const galleryEmpty = document.getElementById('galleryEmpty');
    const photoViewModal = new bootstrap.Modal(document.getElementById('photoViewModal'));
    const photoViewImage = document.getElementById('photoViewImage');
    const photoViewTitle = document.getElementById('photoViewTitle');
    const photoViewDescription = document.getElementById('photoViewDescription');
    
    // Vari√°vel para controlar se as fotos j√° foram carregadas
    let photosLoaded = false;
    
    /**
     * Carrega as fotos da galeria via API
     */
    function loadGalleryPhotos() {
        // Se j√° carregou, n√£o carrega novamente
        if (photosLoaded) return;
        
        // Mostra loading
        galleryLoading.classList.remove('d-none');
        galleryGrid.classList.add('d-none');
        galleryEmpty.classList.add('d-none');
        
        // Faz requisi√ß√£o para a API
        fetch('{{ url_for("api_gallery_photos") }}')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.photos.length > 0) {
                    renderGalleryPhotos(data.photos);
                    photosLoaded = true;
                } else {
                    showEmptyState();
                }
            })
            .catch(error => {
                console.error('Erro ao carregar fotos da galeria:', error);
                showEmptyState();
            })
            .finally(() => {
                galleryLoading.classList.add('d-none');
            });
    }
    
    /**
     * Renderiza as fotos no grid
     * @param {Array} photos - Array de fotos da API
     */
    function renderGalleryPhotos(photos) {
        galleryGrid.innerHTML = '';
        
        photos.forEach(photo => {
            const photoElement = createPhotoElement(photo);
            galleryGrid.appendChild(photoElement);
        });
        
        galleryGrid.classList.remove('d-none');
        
        // Aplica tradu√ß√µes aos novos elementos
        if (window.I18n) {
            window.I18n.updatePageContent();
        }
    }
    
    /**
     * Cria um elemento de foto para o grid
     * @param {Object} photo - Dados da foto
     * @returns {HTMLElement} - Elemento div da foto
     */
    function createPhotoElement(photo) {
        const col = document.createElement('div');
        col.className = 'col-lg-4 col-md-6';
        
        const imagePath = photo.image_path.startsWith('static/') 
            ? '{{ url_for("static", filename="") }}' + photo.image_path.replace('static/', '')
            : '{{ url_for("static", filename="") }}' + photo.image_path;
        
        col.innerHTML = `
            <div class="gallery-item" data-photo-id="${photo.id}">
                <img src="${imagePath}" alt="${photo.title}" loading="lazy">
                <span class="gallery-badge">
                    <i class="fas fa-users me-1"></i>Equipe
                </span>
                <div class="gallery-item-overlay">
                    <p class="gallery-item-title">${photo.title}</p>
                </div>
            </div>
        `;
        
        // Adiciona evento de clique para abrir foto em tela cheia
        const galleryItem = col.querySelector('.gallery-item');
        galleryItem.addEventListener('click', () => {
            openPhotoViewer(photo, imagePath);
        });
        
        return col;
    }
    
    /**
     * Abre o modal de visualiza√ß√£o de foto
     * @param {Object} photo - Dados da foto
     * @param {String} imagePath - Caminho da imagem
     */
    function openPhotoViewer(photo, imagePath) {
        photoViewImage.src = imagePath;
        photoViewImage.alt = photo.title;
        photoViewTitle.textContent = photo.title;
        photoViewDescription.textContent = photo.description || '';
        
        // Esconde o info se n√£o houver descri√ß√£o
        const photoViewInfo = document.getElementById('photoViewInfo');
        if (!photo.description) {
            photoViewInfo.classList.add('d-none');
        } else {
            photoViewInfo.classList.remove('d-none');
        }
        
        photoViewModal.show();
    }
    
    /**
     * Mostra o estado vazio (sem fotos)
     */
    function showEmptyState() {
        galleryGrid.classList.add('d-none');
        galleryEmpty.classList.remove('d-none');
    }
    
    /**
     * Evento quando o modal √© aberto
     * Carrega as fotos na primeira vez
     */
    if (teamGalleryModal) {
        teamGalleryModal.addEventListener('shown.bs.modal', function() {
            loadGalleryPhotos();
        });
    }
    
    console.log('L.A.A.R.I: Sistema de galeria da equipe carregado com sucesso');
})();

{% if current_user.is_authenticated and current_user.is_admin %}
(function() {
    'use strict';
    
    const toggleUploadFormBtn = document.getElementById('toggleUploadFormBtn');
    const uploadFormContainer = document.getElementById('uploadFormContainer');
    const cancelUploadBtn = document.getElementById('cancelUploadBtn');
    const teamPhotoUploadForm = document.getElementById('teamPhotoUploadForm');
    const photoImageInput = document.getElementById('photoImage');
    const imagePreview = document.getElementById('imagePreview');
    const imagePreviewContainer = document.getElementById('imagePreviewContainer');
    
    toggleUploadFormBtn.addEventListener('click', function() {
        uploadFormContainer.classList.toggle('d-none');
        if (!uploadFormContainer.classList.contains('d-none')) {
            document.getElementById('photoTitle').focus();
        }
    });
    
    cancelUploadBtn.addEventListener('click', function() {
        uploadFormContainer.classList.add('d-none');
        teamPhotoUploadForm.reset();
        imagePreviewContainer.style.display = 'none';
    });
    
    photoImageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                imagePreview.src = e.target.result;
                imagePreviewContainer.style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            imagePreviewContainer.style.display = 'none';
        }
    });
    
    teamPhotoUploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;
        
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
        
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Enviando...';
        
        fetch('{{ url_for("upload_team_photo") }}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (window.LAARI && window.LAARI.showNotification) {
                    window.LAARI.showNotification(data.message, 'success');
                } else {
                    alert(data.message);
                }
                
                teamPhotoUploadForm.reset();
                imagePreviewContainer.style.display = 'none';
                uploadFormContainer.classList.add('d-none');
                
                photosLoaded = false;
                loadGalleryPhotos();
            } else {
                if (window.LAARI && window.LAARI.showNotification) {
                    window.LAARI.showNotification(data.error || 'Erro ao enviar foto.', 'error');
                } else {
                    alert(data.error || 'Erro ao enviar foto.');
                }
            }
        })
        .catch(error => {
            console.error('Erro ao enviar foto:', error);
            if (window.LAARI && window.LAARI.showNotification) {
                window.LAARI.showNotification('Erro ao enviar foto. Tente novamente.', 'error');
            } else {
                alert('Erro ao enviar foto. Tente novamente.');
            }
        })
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnText;
        });
    });
})();
{% endif %}
</script>
{% endblock %}
