{% extends "base.html" %}

{% block title %}Modelo 3D - L.A.A.R.I{% endblock %}

{% block content %}
<div class="page-header mb-4">
    <h1 class="display-6 fw-bold">
        <i class="fas fa-cube me-3"></i><span data-i18n="model_3d_page_title">Modelo 3D</span>
    </h1>
    <p class="lead text-muted" data-i18n="model_3d_page_subtitle">Integração com tecnologia de digitalização tridimensional</p>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card border-0 shadow">
            <div class="card-header bg-archaeological text-white">
                <h4 class="mb-0">
                    <i class="fas fa-plus-circle me-2"></i><span data-i18n="model_3d_register_title">Registrar Novo Modelo 3D</span>
                </h4>
            </div>
            
            <div class="card-body p-4">
                <form method="POST" enctype="multipart/form-data">
                    {{ form.hidden_tag() }}
                    
                    <div class="row g-3">
                        <div class="col-12">
                            <label for="{{ form.artifact_id.id }}" class="form-label fw-bold">
                                <i class="fas fa-archive me-2"></i><span data-i18n="form_artifact">Artefato</span> *
                            </label>
                            {{ form.artifact_id(class="form-select form-select-lg") }}
                            {% if form.artifact_id.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.artifact_id.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <label for="{{ form.scanner_type.id }}" class="form-label fw-bold">
                                <i class="fas fa-scanner me-2"></i><span data-i18n="form_scanner_type">Tipo de Scanner</span>
                            </label>
                            <input type="text" name="scanner_type" id="{{ form.scanner_type.id }}" class="form-control" data-i18n="model_3d_placeholder_scanner" placeholder="Ex: Artec Eva, NextEngine, etc." value="{{ form.scanner_type.data or '' }}">
                            {% if form.scanner_type.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.scanner_type.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <label for="{{ form.resolution.id }}" class="form-label fw-bold">
                                <i class="fas fa-expand-arrows-alt me-2"></i><span data-i18n="form_resolution">Resolução</span>
                            </label>
                            <input type="text" name="resolution" id="{{ form.resolution.id }}" class="form-control" data-i18n="model_3d_placeholder_resolution" placeholder="Ex: 0.1mm, 0.5mm, etc." value="{{ form.resolution.data or '' }}">
                            {% if form.resolution.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.resolution.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-12">
                            <label for="{{ form.scan_file.id }}" class="form-label fw-bold">
                                <i class="fas fa-file-upload me-2"></i><span data-i18n="form_model_3d">Arquivo do Modelo 3D</span>
                            </label>
                            {{ form.scan_file(class="form-control", accept=".obj,.ply,.stl,.fbx,.glb,.gltf") }}
                            <small class="form-text text-muted" data-i18n="model_3d_file_formats">Formatos aceitos: OBJ, PLY, STL, FBX, GLB, GLTF (Máx. 16MB)</small>
                            {% if form.scan_file.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.scan_file.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-12">
                            <label for="{{ form.notes.id }}" class="form-label fw-bold">
                                <i class="fas fa-sticky-note me-2"></i><span data-i18n="model_3d_notes_label">Observações</span>
                            </label>
                            <textarea name="notes" id="{{ form.notes.id }}" class="form-control" rows="4" data-i18n="model_3d_placeholder_notes" placeholder="Adicione observações sobre o processo de digitalização, qualidade do scan, etc.">{{ form.notes.data or '' }}</textarea>
                            {% if form.notes.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.notes.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-4">
                        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary btn-lg">
                            <i class="fas fa-arrow-left me-2"></i><span data-i18n="btn_back">Voltar</span>
                        </a>
                        
                        <button type="submit" class="btn btn-archaeological btn-lg">
                            <i class="fas fa-save me-2"></i><span data-i18n="model_3d_btn_register">Registrar Modelo</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card border-0 shadow mt-4">
            <div class="card-header bg-secondary text-white">
                <h4 class="mb-0">
                    <i class="fas fa-lock me-2"></i><span data-i18n="ai3d_dev_title">Reconstrução 3D por Inteligência Artificial</span>
                    <span class="badge bg-warning text-dark ms-2" data-i18n="ai3d_dev_badge">Em Desenvolvimento</span>
                </h4>
            </div>
            <div class="card-body p-4">
                <div class="row">
                    <div class="col-md-7">
                        <p class="mb-3" data-i18n-html="ai3d_dev_intro">
                            A funcionalidade de reconstrução tridimensional de artefatos arqueológicos por meio de 
                            Inteligência Artificial faz parte do <strong>roadmap do L.A.A.R.I</strong>.
                        </p>
                        <p class="mb-3" data-i18n="ai3d_dev_context">No momento, o sistema apresenta a proposta conceitual e metodológica, considerando:</p>
                        <ul class="list-unstyled mb-3">
                            <li class="mb-2">
                                <i class="fas fa-graduation-cap text-archaeological me-2"></i>
                                <strong data-i18n="ai3d_dev_edu_title">Uso educacional:</strong> <span data-i18n="ai3d_dev_edu_desc">Ferramenta de apoio didático e divulgação científica</span>
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-microscope text-archaeological me-2"></i>
                                <strong data-i18n="ai3d_dev_transparency_title">Transparência científica:</strong> <span data-i18n="ai3d_dev_transparency_desc">Distinção clara entre modelos estimados e escaneamentos profissionais</span>
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-cogs text-archaeological me-2"></i>
                                <strong data-i18n="ai3d_dev_limitations_title">Limitações técnicas e financeiras:</strong> <span data-i18n="ai3d_dev_limitations_desc">Dependência de serviços especializados de geração 3D</span>
                            </li>
                        </ul>
                        <div class="alert alert-info mb-0">
                            <i class="fas fa-road me-2"></i>
                            <strong data-i18n="ai3d_dev_forecast_title">Previsão:</strong> <span data-i18n="ai3d_dev_forecast_desc">A implementação completa está prevista para versões futuras da plataforma, mediante integração com serviços especializados de geração 3D por IA.</span>
                        </div>
                    </div>
                    
                    <div class="col-md-5">
                        <div class="card bg-light border-0 h-100">
                            <div class="card-body d-flex flex-column align-items-center justify-content-center py-4">
                                <div class="workflow-step text-center mb-3">
                                    <div class="rounded-circle bg-archaeological text-white d-inline-flex align-items-center justify-content-center mb-2" style="width: 50px; height: 50px;">
                                        <i class="fas fa-upload"></i>
                                    </div>
                                    <div class="fw-bold" data-i18n="ai3d_dev_step1_title">1. Upload da Imagem</div>
                                    <div class="small text-muted" data-i18n="ai3d_dev_step1_desc">Foto do artefato catalogado</div>
                                </div>
                                <i class="fas fa-arrow-down text-archaeological fs-5 mb-3"></i>
                                <div class="workflow-step text-center mb-3">
                                    <div class="rounded-circle bg-archaeological text-white d-inline-flex align-items-center justify-content-center mb-2" style="width: 50px; height: 50px;">
                                        <i class="fas fa-brain"></i>
                                    </div>
                                    <div class="fw-bold" data-i18n="ai3d_dev_step2_title">2. Processamento por IA</div>
                                    <div class="small text-muted" data-i18n="ai3d_dev_step2_desc">Análise e reconstrução automática</div>
                                </div>
                                <i class="fas fa-arrow-down text-archaeological fs-5 mb-3"></i>
                                <div class="workflow-step text-center">
                                    <div class="rounded-circle bg-archaeological text-white d-inline-flex align-items-center justify-content-center mb-2" style="width: 50px; height: 50px;">
                                        <i class="fas fa-cube"></i>
                                    </div>
                                    <div class="fw-bold" data-i18n="ai3d_dev_step3_title">3. Modelo 3D Estimado</div>
                                    <div class="small text-muted" data-i18n="ai3d_dev_step3_desc">Visualização e download</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="text-center mt-4">
                    <span class="badge bg-secondary p-2">
                        <i class="fas fa-info-circle me-1"></i>
                        <span data-i18n="ai3d_dev_inactive_notice">Esta funcionalidade está em fase de planejamento e não está ativa no momento</span>
                    </span>
                </div>
            </div>
        </div>
        
        <div class="card border-0 shadow mt-4">
            <div class="card-header bg-archaeological text-white">
                <h5 class="mb-0">
                    <i class="fas fa-images me-2"></i><span data-i18n="ai3d_examples_title">Exemplos de Reconstrução 3D (Referência Visual)</span>
                </h5>
            </div>
            <div class="card-body p-4">
                <p class="text-muted mb-3" data-i18n="ai3d_examples_desc">
                    Modelos ilustrativos demonstrando como artefatos arqueológicos podem ser representados em 3D para fins educacionais.
                </p>
                <div class="row justify-content-center g-4">
                    <div class="col-md-4 col-sm-6">
                        <div class="text-center">
                            <img src="{{ url_for('static', filename='images/3d_examples/3d_example_1.png') }}" 
                                 class="img-fluid rounded shadow" 
                                 alt="Modelo 3D estimado por IA (exemplo ilustrativo)"
                                 style="max-height: 150px; object-fit: contain; background-color: #f8f9fa;">
                            <div class="small text-muted mt-2"><em data-i18n="ai3d_examples_caption">Modelo 3D estimado por IA (exemplo ilustrativo)</em></div>
                        </div>
                    </div>
                    <div class="col-md-4 col-sm-6">
                        <div class="text-center">
                            <img src="{{ url_for('static', filename='images/3d_examples/3d_example_2.png') }}" 
                                 class="img-fluid rounded shadow" 
                                 alt="Modelo 3D estimado por IA (exemplo ilustrativo)"
                                 style="max-height: 150px; object-fit: contain; background-color: #f8f9fa;">
                            <div class="small text-muted mt-2"><em data-i18n="ai3d_examples_caption">Modelo 3D estimado por IA (exemplo ilustrativo)</em></div>
                        </div>
                    </div>
                    <div class="col-md-4 col-sm-6">
                        <div class="text-center">
                            <img src="{{ url_for('static', filename='images/3d_examples/3d_example_3.png') }}" 
                                 class="img-fluid rounded shadow" 
                                 alt="Modelo 3D estimado por IA (exemplo ilustrativo)"
                                 style="max-height: 150px; object-fit: contain; background-color: #f8f9fa;">
                            <div class="small text-muted mt-2"><em data-i18n="ai3d_examples_caption">Modelo 3D estimado por IA (exemplo ilustrativo)</em></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card border-0 shadow mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i><span data-i18n="model_3d_about_title">Sobre Modelo 3D</span>
                </h5>
            </div>
            <div class="card-body">
                <p class="mb-3" data-i18n="model_3d_about_desc">A digitalização 3D é uma tecnologia fundamental na arqueologia moderna, permitindo:</p>
                <ul class="list-unstyled">
                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i><span data-i18n="model_3d_about_item1">Preservação digital permanente</span></li>
                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i><span data-i18n="model_3d_about_item2">Análise detalhada sem manuseio</span></li>
                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i><span data-i18n="model_3d_about_item3">Compartilhamento de dados</span></li>
                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i><span data-i18n="model_3d_about_item4">Reconstrução virtual</span></li>
                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i><span data-i18n="model_3d_about_item5">Documentação científica</span></li>
                </ul>
            </div>
        </div>
        
        <div class="card border-0 shadow">
            <div class="card-header bg-warning text-white">
                <h5 class="mb-0">
                    <i class="fas fa-lightbulb me-2"></i><span data-i18n="model_3d_tips_title">Dicas de Digitalização</span>
                </h5>
            </div>
            <div class="card-body">
                <div class="tip-item mb-3">
                    <h6 class="fw-bold" data-i18n="model_3d_tip_prep_title">Preparação</h6>
                    <small class="text-muted" data-i18n="model_3d_tip_prep_desc">Limpe cuidadosamente o artefato antes da digitalização</small>
                </div>
                <div class="tip-item mb-3">
                    <h6 class="fw-bold" data-i18n="model_3d_tip_light_title">Iluminação</h6>
                    <small class="text-muted" data-i18n="model_3d_tip_light_desc">Use iluminação uniforme e difusa</small>
                </div>
                <div class="tip-item mb-3">
                    <h6 class="fw-bold" data-i18n="model_3d_tip_angles_title">Múltiplos Ângulos</h6>
                    <small class="text-muted" data-i18n="model_3d_tip_angles_desc">Capture todas as superfícies visíveis</small>
                </div>
                <div class="tip-item">
                    <h6 class="fw-bold" data-i18n="model_3d_tip_validation_title">Validação</h6>
                    <small class="text-muted" data-i18n="model_3d_tip_validation_desc">Sempre verifique a qualidade do modelo final</small>
                </div>
            </div>
        </div>
    </div>
</div>

{% if scans %}
<div class="mt-5">
    <h3 class="h4 mb-4" data-i18n="model_3d_registered_title">Modelos 3D Registrados</h3>
    
    <div class="card border-0 shadow">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th data-i18n="model_3d_table_artifact">Artefato</th>
                            <th data-i18n="model_3d_table_model_date">Data do Modelo</th>
                            <th data-i18n="model_3d_table_equipment">Equipamento</th>
                            <th data-i18n="model_3d_table_resolution">Resolução</th>
                            <th data-i18n="model_3d_table_size">Tamanho</th>
                            <th data-i18n="model_3d_table_file">Arquivo</th>
                            <th data-i18n="model_3d_table_actions">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for scan in scans %}
                        <tr>
                            <td>
                                <div class="fw-bold">{{ scan.artifact.name }}</div>
                                <small class="text-muted">{{ scan.artifact.qr_code }}</small>
                            </td>
                            <td>{{ scan.scan_date.strftime('%d/%m/%Y %H:%M') }}</td>
                            <td>
                                <span class="badge {% if scan.is_ai_generated %}bg-info{% else %}bg-archaeological{% endif %}">
                                    {% if scan.is_ai_generated %}
                                        <i class="fas fa-robot me-1"></i>IA
                                    {% elif scan.scanner_type %}
                                        {{ scan.scanner_type }}
                                    {% else %}
                                        <span data-i18n="model_3d_not_specified">Não especificado</span>
                                    {% endif %}
                                </span>
                            </td>
                            <td>
                                {% if scan.resolution %}
                                    <small class="text-muted">{{ scan.resolution }}</small>
                                {% else %}
                                    <small class="text-muted" data-i18n="model_3d_empty_field">-</small>
                                {% endif %}
                            </td>
                            <td>
                                {% if scan.file_size %}
                                    <small class="text-muted">{{ "%.2f"|format(scan.file_size / 1024 / 1024) }} MB</small>
                                {% else %}
                                    <small class="text-muted" data-i18n="model_3d_empty_field">-</small>
                                {% endif %}
                            </td>
                            <td>
                                {% if scan.file_path %}
                                    <span class="badge bg-success">
                                        <i class="fas fa-file-alt me-1"></i><span data-i18n="model_3d_file_available">Disponível</span>
                                    </span>
                                {% elif scan.is_ai_generated and scan.ai_status in ['PENDING', 'IN_PROGRESS', 'PROCESSING'] %}
                                    <span class="badge bg-warning">
                                        <i class="fas fa-spinner fa-spin me-1"></i>Processando
                                    </span>
                                {% else %}
                                    <span class="badge bg-secondary">
                                        <i class="fas fa-file-times me-1"></i><span data-i18n="model_3d_file_unavailable">Sem arquivo</span>
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    {% if scan.file_path %}
                                    <a href="{{ url_for('view_3d_model', scan_id=scan.id) }}" class="btn btn-outline-archaeological" title="Visualizar">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="{{ scan.file_path }}" class="btn btn-outline-success" title="Download" download>
                                        <i class="fas fa-download"></i>
                                    </a>
                                    {% elif scan.is_ai_generated and scan.ai_status in ['PENDING', 'IN_PROGRESS', 'PROCESSING'] %}
                                    <button type="button" class="btn btn-outline-info" onclick="checkStatus({{ scan.id }})" title="Verificar status">
                                        <i class="fas fa-sync"></i>
                                    </button>
                                    {% endif %}
                                    {% if current_user.is_admin or (scan.generated_by_user_id and scan.generated_by_user_id == current_user.id) or (scan.artifact and scan.artifact.user_id == current_user.id) %}
                                    <form action="{{ url_for('delete_3d_scan', scan_id=scan.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Tem certeza que deseja excluir este registro 3D?');">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" class="btn btn-outline-danger" title="Excluir">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const fileInput = document.getElementById('scan_file');
        
        if (fileInput) {
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                
                if (file) {
                    const fileSize = (file.size / 1024 / 1024).toFixed(2);
                    console.log(`Arquivo selecionado: ${file.name} (${fileSize} MB)`);
                    
                    if (file.size > 16 * 1024 * 1024) {
                        alert('O arquivo excede o limite de 16MB. Por favor, selecione um arquivo menor.');
                        this.value = '';
                    }
                }
            });
        }
    });
</script>
{% endblock %}
