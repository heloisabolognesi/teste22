{% extends "base.html" %}

{% block title %}Modelo 3D - L.A.A.R.I{% endblock %}

{% block content %}
<div class="page-header mb-4">
    <h1 class="display-6 fw-bold">
        <i class="fas fa-cube me-3"></i><span data-i18n="model_3d_page_title">Modelo 3D</span>
    </h1>
    <p class="lead text-muted" data-i18n="model_3d_page_subtitle">Integração com tecnologia de digitalização tridimensional</p>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card border-0 shadow">
            <div class="card-header bg-archaeological text-white">
                <h4 class="mb-0">
                    <i class="fas fa-plus-circle me-2"></i><span data-i18n="model_3d_register_title">Registrar Novo Modelo 3D</span>
                </h4>
            </div>
            
            <div class="card-body p-4">
                <form method="POST" enctype="multipart/form-data">
                    {{ form.hidden_tag() }}
                    
                    <div class="row g-3">
                        <div class="col-12">
                            <label for="{{ form.artifact_id.id }}" class="form-label fw-bold">
                                <i class="fas fa-archive me-2"></i><span data-i18n="form_artifact">Artefato</span> *
                            </label>
                            {{ form.artifact_id(class="form-select form-select-lg") }}
                            {% if form.artifact_id.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.artifact_id.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <label for="{{ form.scanner_type.id }}" class="form-label fw-bold">
                                <i class="fas fa-scanner me-2"></i><span data-i18n="form_scanner_type">Tipo de Scanner</span>
                            </label>
                            <input type="text" name="scanner_type" id="{{ form.scanner_type.id }}" class="form-control" data-i18n="model_3d_placeholder_scanner" placeholder="Ex: Artec Eva, NextEngine, etc." value="{{ form.scanner_type.data or '' }}">
                            {% if form.scanner_type.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.scanner_type.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <label for="{{ form.resolution.id }}" class="form-label fw-bold">
                                <i class="fas fa-expand-arrows-alt me-2"></i><span data-i18n="form_resolution">Resolução</span>
                            </label>
                            <input type="text" name="resolution" id="{{ form.resolution.id }}" class="form-control" data-i18n="model_3d_placeholder_resolution" placeholder="Ex: 0.1mm, 0.5mm, etc." value="{{ form.resolution.data or '' }}">
                            {% if form.resolution.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.resolution.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-12">
                            <label for="{{ form.scan_file.id }}" class="form-label fw-bold">
                                <i class="fas fa-file-upload me-2"></i><span data-i18n="form_model_3d">Arquivo do Modelo 3D</span>
                            </label>
                            {{ form.scan_file(class="form-control", accept=".obj,.ply,.stl,.fbx,.glb,.gltf") }}
                            <small class="form-text text-muted" data-i18n="model_3d_file_formats">Formatos aceitos: OBJ, PLY, STL, FBX, GLB, GLTF (Máx. 16MB)</small>
                            {% if form.scan_file.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.scan_file.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-12">
                            <label for="{{ form.notes.id }}" class="form-label fw-bold">
                                <i class="fas fa-sticky-note me-2"></i><span data-i18n="model_3d_notes_label">Observações</span>
                            </label>
                            <textarea name="notes" id="{{ form.notes.id }}" class="form-control" rows="4" data-i18n="model_3d_placeholder_notes" placeholder="Adicione observações sobre o processo de digitalização, qualidade do scan, etc.">{{ form.notes.data or '' }}</textarea>
                            {% if form.notes.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.notes.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-4">
                        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary btn-lg">
                            <i class="fas fa-arrow-left me-2"></i><span data-i18n="btn_back">Voltar</span>
                        </a>
                        
                        <button type="submit" class="btn btn-archaeological btn-lg">
                            <i class="fas fa-save me-2"></i><span data-i18n="model_3d_btn_register">Registrar Modelo</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        {% if ai_configured and (current_user.is_admin or current_user.can_catalog_artifacts()) %}
        <div class="card border-0 shadow mt-4">
            <div class="card-header bg-info text-white">
                <h4 class="mb-0">
                    <i class="fas fa-robot me-2"></i>Reconstrução 3D por IA
                </h4>
            </div>
            <div class="card-body p-4 text-center">
                <p class="mb-3">Gere modelos 3D estimados a partir de fotos de artefatos usando inteligência artificial.</p>
                <a href="{{ url_for('gerar_3d_ia') }}" class="btn btn-lg btn-archaeological">
                    <i class="fas fa-magic me-2"></i>Gerar modelo 3D (IA)
                </a>
                <p class="small text-muted mt-3 mb-0">
                    <i class="fas fa-info-circle me-1"></i>
                    Destinado a visualização e fins educacionais. Não substitui escaneamento profissional.
                </p>
            </div>
        </div>
        {% endif %}
    </div>
    
    <div class="col-lg-4">
        <div class="card border-0 shadow mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i><span data-i18n="model_3d_about_title">Sobre Modelo 3D</span>
                </h5>
            </div>
            <div class="card-body">
                <p class="mb-3" data-i18n="model_3d_about_desc">A digitalização 3D é uma tecnologia fundamental na arqueologia moderna, permitindo:</p>
                <ul class="list-unstyled">
                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i><span data-i18n="model_3d_about_item1">Preservação digital permanente</span></li>
                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i><span data-i18n="model_3d_about_item2">Análise detalhada sem manuseio</span></li>
                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i><span data-i18n="model_3d_about_item3">Compartilhamento de dados</span></li>
                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i><span data-i18n="model_3d_about_item4">Reconstrução virtual</span></li>
                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i><span data-i18n="model_3d_about_item5">Documentação científica</span></li>
                </ul>
            </div>
        </div>
        
        <div class="card border-0 shadow">
            <div class="card-header bg-warning text-white">
                <h5 class="mb-0">
                    <i class="fas fa-lightbulb me-2"></i><span data-i18n="model_3d_tips_title">Dicas de Digitalização</span>
                </h5>
            </div>
            <div class="card-body">
                <div class="tip-item mb-3">
                    <h6 class="fw-bold" data-i18n="model_3d_tip_prep_title">Preparação</h6>
                    <small class="text-muted" data-i18n="model_3d_tip_prep_desc">Limpe cuidadosamente o artefato antes da digitalização</small>
                </div>
                <div class="tip-item mb-3">
                    <h6 class="fw-bold" data-i18n="model_3d_tip_light_title">Iluminação</h6>
                    <small class="text-muted" data-i18n="model_3d_tip_light_desc">Use iluminação uniforme e difusa</small>
                </div>
                <div class="tip-item mb-3">
                    <h6 class="fw-bold" data-i18n="model_3d_tip_angles_title">Múltiplos Ângulos</h6>
                    <small class="text-muted" data-i18n="model_3d_tip_angles_desc">Capture todas as superfícies visíveis</small>
                </div>
                <div class="tip-item">
                    <h6 class="fw-bold" data-i18n="model_3d_tip_validation_title">Validação</h6>
                    <small class="text-muted" data-i18n="model_3d_tip_validation_desc">Sempre verifique a qualidade do modelo final</small>
                </div>
            </div>
        </div>
    </div>
</div>

{% if scans %}
<div class="mt-5">
    <h3 class="h4 mb-4" data-i18n="model_3d_registered_title">Modelos 3D Registrados</h3>
    
    <div class="card border-0 shadow">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th data-i18n="model_3d_table_artifact">Artefato</th>
                            <th data-i18n="model_3d_table_model_date">Data do Modelo</th>
                            <th data-i18n="model_3d_table_equipment">Equipamento</th>
                            <th data-i18n="model_3d_table_resolution">Resolução</th>
                            <th data-i18n="model_3d_table_size">Tamanho</th>
                            <th data-i18n="model_3d_table_file">Arquivo</th>
                            <th data-i18n="model_3d_table_actions">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for scan in scans %}
                        <tr>
                            <td>
                                <div class="fw-bold">{{ scan.artifact.name }}</div>
                                <small class="text-muted">{{ scan.artifact.qr_code }}</small>
                            </td>
                            <td>{{ scan.scan_date.strftime('%d/%m/%Y %H:%M') }}</td>
                            <td>
                                <span class="badge {% if scan.is_ai_generated %}bg-info{% else %}bg-archaeological{% endif %}">
                                    {% if scan.is_ai_generated %}
                                        <i class="fas fa-robot me-1"></i>IA
                                    {% elif scan.scanner_type %}
                                        {{ scan.scanner_type }}
                                    {% else %}
                                        <span data-i18n="model_3d_not_specified">Não especificado</span>
                                    {% endif %}
                                </span>
                            </td>
                            <td>
                                {% if scan.resolution %}
                                    <small class="text-muted">{{ scan.resolution }}</small>
                                {% else %}
                                    <small class="text-muted" data-i18n="model_3d_empty_field">-</small>
                                {% endif %}
                            </td>
                            <td>
                                {% if scan.file_size %}
                                    <small class="text-muted">{{ "%.2f"|format(scan.file_size / 1024 / 1024) }} MB</small>
                                {% else %}
                                    <small class="text-muted" data-i18n="model_3d_empty_field">-</small>
                                {% endif %}
                            </td>
                            <td>
                                {% if scan.file_path %}
                                    <span class="badge bg-success">
                                        <i class="fas fa-file-alt me-1"></i><span data-i18n="model_3d_file_available">Disponível</span>
                                    </span>
                                {% elif scan.is_ai_generated and scan.ai_status in ['PENDING', 'IN_PROGRESS', 'PROCESSING'] %}
                                    <span class="badge bg-warning">
                                        <i class="fas fa-spinner fa-spin me-1"></i>Processando
                                    </span>
                                {% else %}
                                    <span class="badge bg-secondary">
                                        <i class="fas fa-file-times me-1"></i><span data-i18n="model_3d_file_unavailable">Sem arquivo</span>
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    {% if scan.file_path %}
                                    <a href="{{ url_for('view_3d_model', scan_id=scan.id) }}" class="btn btn-outline-archaeological" title="Visualizar">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="{{ scan.file_path }}" class="btn btn-outline-success" title="Download" download>
                                        <i class="fas fa-download"></i>
                                    </a>
                                    {% elif scan.is_ai_generated and scan.ai_status in ['PENDING', 'IN_PROGRESS', 'PROCESSING'] %}
                                    <button type="button" class="btn btn-outline-info" onclick="checkStatus({{ scan.id }})" title="Verificar status">
                                        <i class="fas fa-sync"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    function checkStatus(scanId) {
        fetch(`/check_3d_status/${scanId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.status === 'SUCCEEDED') {
                        location.reload();
                    } else if (data.status === 'FAILED') {
                        alert('A geração do modelo falhou. Tente novamente.');
                        location.reload();
                    } else {
                        alert(`Status: ${data.status}. Progresso: ${data.progress || 0}%`);
                    }
                } else {
                    alert('Erro ao verificar status: ' + (data.error || 'Erro desconhecido'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Erro ao verificar status.');
            });
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        const fileInput = document.getElementById('scan_file');
        
        if (fileInput) {
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                
                if (file) {
                    const fileSize = (file.size / 1024 / 1024).toFixed(2);
                    console.log(`Arquivo selecionado: ${file.name} (${fileSize} MB)`);
                    
                    if (file.size > 16 * 1024 * 1024) {
                        alert('O arquivo excede o limite de 16MB. Por favor, selecione um arquivo menor.');
                        this.value = '';
                    }
                }
            });
        }
    });
</script>
{% endblock %}
