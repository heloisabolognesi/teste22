{% extends "base.html" %}

{% block title %}Dashboard - L.A.A.R.I{% endblock %}

{% block content %}
<div class="dashboard-header mb-4">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
        <div>
            <h1 class="display-6 fw-bold">
                <i class="fas fa-home me-3"></i><span data-i18n="dashboard_title">Dashboard</span> L.A.A.R.I
            </h1>
            <p class="lead text-muted mb-0"><span data-i18n="dashboard_welcome">Bem-vindo ao sistema de gest√£o arqueol√≥gica</span>, {{ current_user.username }}!</p>
        </div>
        <button class="btn btn-archaeological d-flex align-items-center gap-2 px-3 py-2 shadow-sm" 
                type="button" 
                id="teamGalleryBtn"
                data-bs-toggle="modal" 
                data-bs-target="#teamGalleryModal"
                data-i18n-aria="btn_conheca_equipe">
            <i class="fas fa-users"></i>
            <span data-i18n="btn_conheca_equipe">Conhe√ßa nossa equipe</span>
        </button>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row g-4 mb-5">
    <div class="col-lg-4 col-md-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center p-4">
                <div class="stat-icon bg-archaeological text-white rounded-circle mx-auto mb-3">
                    <i class="fas fa-archive fa-2x"></i>
                </div>
                <h3 class="h4 fw-bold">{{ stats.artifacts }}</h3>
                <p class="text-muted mb-0" data-i18n="stats_artifacts_cataloged">Artefatos Catalogados</p>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4 col-md-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center p-4">
                <div class="stat-icon bg-archaeological text-white rounded-circle mx-auto mb-3">
                    <i class="fas fa-users fa-2x"></i>
                </div>
                <h3 class="h4 fw-bold">{{ stats.professionals }}</h3>
                <p class="text-muted mb-0" data-i18n="stats_professionals_registered">Profissionais Cadastrados</p>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4 col-md-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center p-4">
                <div class="stat-icon bg-warning text-white rounded-circle mx-auto mb-3">
                    <i class="fas fa-truck fa-2x"></i>
                </div>
                <h3 class="h4 fw-bold">{{ stats.pending_transports }}</h3>
                <p class="text-muted mb-0" data-i18n="stats_pending_transports">Transportes Pendentes</p>
            </div>
        </div>
    </div>
</div>

<!-- Main Modules -->
<div class="modules-grid">
    <h2 class="h3 mb-4" data-i18n="modules_main">M√≥dulos Principais</h2>
    
    <div class="row g-4">
        <div class="col-lg-4 col-md-6">
            <div class="card module-card h-100 border-0 shadow-sm">
                <div class="card-body p-4 text-center">
                    <div class="module-icon bg-archaeological text-white rounded-circle mx-auto mb-3">
                        <i class="fas fa-archive fa-2x"></i>
                    </div>
                    <h4 class="card-title" data-i18n="module_collection">Acervo</h4>
                    <p class="card-text text-muted" data-i18n="module_collection_desc">Consulta organizada de todos os itens catalogados no sistema.</p>
                    <a href="{{ url_for('acervo') }}" class="btn btn-archaeological">
                        <i class="fas fa-arrow-right me-2"></i><span data-i18n="module_collection_btn">Acessar Acervo</span>
                    </a>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4 col-md-6">
            <div class="card module-card h-100 border-0 shadow-sm">
                <div class="card-body p-4 text-center">
                    <div class="module-icon bg-archaeological text-white rounded-circle mx-auto mb-3">
                        <i class="fas fa-tags fa-2x"></i>
                    </div>
                    <h4 class="card-title" data-i18n="module_cataloging">Cataloga√ß√£o</h4>
                    <p class="card-text text-muted" data-i18n="module_cataloging_desc">Sistema completo de registro e cataloga√ß√£o de artefatos.</p>
                    <a href="{{ url_for('catalogacao') }}" class="btn btn-archaeological">
                        <i class="fas fa-arrow-right me-2"></i><span data-i18n="module_cataloging_btn">Gerenciar Cataloga√ß√£o</span>
                    </a>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4 col-md-6">
            <div class="card module-card h-100 border-0 shadow-sm">
                <div class="card-body p-4 text-center">
                    <div class="module-icon bg-archaeological text-white rounded-circle mx-auto mb-3">
                        <i class="fas fa-cube fa-2x"></i>
                    </div>
                    <h4 class="card-title" data-i18n="module_3d_model">Modelo 3D</h4>
                    <p class="card-text text-muted" data-i18n="module_3d_model_desc">Integra√ß√£o com tecnologia de digitaliza√ß√£o tridimensional.</p>
                    <a href="{{ url_for('scanner_3d') }}" class="btn btn-archaeological">
                        <i class="fas fa-arrow-right me-2"></i><span data-i18n="module_3d_model_btn">Acessar Modelos</span>
                    </a>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4 col-md-6">
            <div class="card module-card h-100 border-0 shadow-sm">
                <div class="card-body p-4 text-center">
                    <div class="module-icon bg-archaeological text-white rounded-circle mx-auto mb-3">
                        <i class="fas fa-users fa-2x"></i>
                    </div>
                    <h4 class="card-title" data-i18n="module_professionals">Profissionais da Regi√£o</h4>
                    <p class="card-text text-muted" data-i18n="module_professionals_desc">Diret√≥rio completo de arque√≥logos e especialistas.</p>
                    <a href="{{ url_for('profissionais') }}" class="btn btn-archaeological">
                        <i class="fas fa-arrow-right me-2"></i><span data-i18n="module_professionals_btn">Ver Profissionais</span>
                    </a>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4 col-md-6">
            <div class="card module-card h-100 border-0 shadow-sm">
                <div class="card-body p-4 text-center">
                    <div class="module-icon bg-archaeological text-white rounded-circle mx-auto mb-3">
                        <i class="fas fa-clipboard-list fa-2x"></i>
                    </div>
                    <h4 class="card-title" data-i18n="module_inventory">Invent√°rio</h4>
                    <p class="card-text text-muted" data-i18n="module_inventory_desc">Controle detalhado do invent√°rio arqueol√≥gico.</p>
                    <a href="{{ url_for('inventario') }}" class="btn btn-archaeological">
                        <i class="fas fa-arrow-right me-2"></i><span data-i18n="module_inventory_btn">Gerenciar Invent√°rio</span>
                    </a>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4 col-md-6">
            <div class="card module-card h-100 border-0 shadow-sm">
                <div class="card-body p-4 text-center">
                    <div class="module-icon bg-archaeological text-white rounded-circle mx-auto mb-3">
                        <i class="fas fa-truck fa-2x"></i>
                    </div>
                    <h4 class="card-title" data-i18n="module_transport">Transporte de Artefatos</h4>
                    <p class="card-text text-muted" data-i18n="module_transport_desc">Controle e rastreamento da movimenta√ß√£o de itens.</p>
                    <a href="{{ url_for('transporte') }}" class="btn btn-archaeological">
                        <i class="fas fa-arrow-right me-2"></i><span data-i18n="module_transport_btn">Controlar Transporte</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

{% if current_user.is_admin %}
<div class="admin-section mt-5">
    <div class="alert alert-info border-0">
        <h5 class="alert-heading">
            <i class="fas fa-crown me-2"></i><span data-i18n="admin_panel">Painel Administrativo</span>
        </h5>
        <p class="mb-2" data-i18n="admin_panel_desc">Voc√™ possui privil√©gios de administrador neste sistema.</p>
        <a href="{{ url_for('admin') }}" class="btn btn-sm btn-info">
            <i class="fas fa-cog me-2"></i><span data-i18n="admin_panel_btn">Acessar Administra√ß√£o</span>
        </a>
    </div>
</div>
{% endif %}

<!-- Modal da Galeria da Equipe -->
<div class="modal fade" id="teamGalleryModal" tabindex="-1" aria-labelledby="teamGalleryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <!-- Cabe√ßalho do Modal -->
            <div class="modal-header bg-archaeological text-white">
                <div>
                    <h5 class="modal-title" id="teamGalleryModalLabel" data-i18n="galeria_modal_title">Nossa Equipe - Tech Era</h5>
                    <small class="d-block opacity-75" data-i18n="galeria_modal_desc">Conhe√ßa os membros da equipe Tech Era e nossos projetos</small>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <!-- Corpo do Modal -->
            <div class="modal-body p-4">
                <!-- Se√ß√£o Descritiva da Tech Era -->
                <div class="team-about-section mb-5">
                    <h4 class="text-archaeological mb-3" data-i18n="team_about_title">Sobre a Tech Era</h4>
                    <p class="lead" data-i18n="team_about_intro">
                        Somos a Tech Era, uma equipe apaixonada por ci√™ncia, tecnologia e rob√≥tica! 
                        Participamos da FIRST Lego League (FLL), onde aprendemos a usar a criatividade e o trabalho em equipe para transformar ideias em solu√ß√µes reais.
                    </p>
                    
                    <p class="mb-3" data-i18n="team_core_values_title">
                        Guiados pelos 6 pilares do Core Values, buscamos colocar em pr√°tica cada um deles em tudo o que fazemos:
                    </p>
                    
                    <div class="core-values-list">
                        <div class="core-value-item">
                            <span class="cv-icon"><i class="fas fa-lightbulb"></i></span>
                            <span data-i18n="team_cv_discovery">Descoberta: aprendemos algo novo a cada desafio.</span>
                        </div>
                        <div class="core-value-item">
                            <span class="cv-icon"><i class="fas fa-rocket"></i></span>
                            <span data-i18n="team_cv_innovation">Inova√ß√£o: criamos solu√ß√µes criativas e originais.</span>
                        </div>
                        <div class="core-value-item">
                            <span class="cv-icon"><i class="fas fa-globe"></i></span>
                            <span data-i18n="team_cv_impact">Impacto: usamos o que sabemos para melhorar o mundo ao nosso redor.</span>
                        </div>
                        <div class="core-value-item">
                            <span class="cv-icon"><i class="fas fa-hands-helping"></i></span>
                            <span data-i18n="team_cv_inclusion">Inclus√£o: valorizamos cada voz e respeitamos as diferen√ßas.</span>
                        </div>
                        <div class="core-value-item">
                            <span class="cv-icon"><i class="fas fa-users"></i></span>
                            <span data-i18n="team_cv_teamwork">Trabalho em equipe: colaboramos e crescemos juntos.</span>
                        </div>
                        <div class="core-value-item">
                            <span class="cv-icon"><i class="fas fa-smile"></i></span>
                            <span data-i18n="team_cv_fun">Divers√£o: celebramos cada conquista com alegria e entusiasmo!</span>
                        </div>
                    </div>
                    
                    <p class="lead text-center mt-4 mb-0 text-archaeological fw-bold" data-i18n="team_conclusion">
                        Acreditamos que a verdadeira tecnologia nasce das pessoas ‚Äî quando mentes curiosas se unem para criar solu√ß√µes que fazem a diferen√ßa. √â na troca de ideias e na vontade de transformar que encontramos nossa for√ßa. √â assim que a Tech Era transforma o presente e constr√≥i o futuro! üíú
                    </p>
                    
                    <hr class="my-4">
                    <h5 class="text-center mb-4" data-i18n="gallery_photos_team">Galeria de Fotos da Equipe</h5>
                </div>
                
                <!-- √Årea de carregamento -->
                <div id="galleryLoading" class="text-center py-5">
                    <div class="spinner-border text-archaeological" role="status">
                        <span class="visually-hidden" data-i18n="gallery_loading">Carregando...</span>
                    </div>
                    <p class="text-muted mt-3" data-i18n="gallery_loading_text">Carregando galeria...</p>
                </div>
                
                <!-- Grid de fotos -->
                <div id="galleryGrid" class="row g-3 d-none">
                    <!-- As fotos ser√£o carregadas dinamicamente via JavaScript -->
                </div>
                
                <!-- Estado vazio -->
                <div id="galleryEmpty" class="text-center py-5 d-none">
                    <i class="fas fa-images fa-4x text-muted mb-3"></i>
                    <h4 class="text-muted" data-i18n="gallery_no_photos">Nenhuma foto dispon√≠vel</h4>
                    <p class="text-muted" data-i18n="gallery_empty_text">A galeria est√° vazia no momento.</p>
                </div>
                
                <!-- Formul√°rio de Upload (apenas para admins) - MOVIDO PARA DENTRO DO MODAL-BODY -->
                {% if current_user.is_authenticated and current_user.is_admin %}
                <div id="uploadFormContainer" class="border-top bg-light p-4 mt-4 mb-4 d-none" style="border-radius: 8px;">
                    <h5 class="mb-3"><i class="fas fa-camera me-2"></i><span data-i18n="upload_new_team_photo">Adicionar Nova Foto da Equipe</span></h5>
                    <form id="teamPhotoUploadForm" enctype="multipart/form-data">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="photoTitle" class="form-label"><span data-i18n="upload_title_label">T√≠tulo</span> <span class="text-danger" data-i18n="required_asterisk">*</span></label>
                                <input type="text" class="form-control" id="photoTitle" name="title" required>
                            </div>
                            <div class="col-md-6">
                                <label for="photoImage" class="form-label"><span data-i18n="upload_image_label">Imagem</span> <span class="text-danger" data-i18n="required_asterisk">*</span></label>
                                <input type="file" class="form-control" id="photoImage" name="image" accept="image/jpeg,image/png,image/gif" required>
                            </div>
                            <div class="col-12">
                                <label for="photoDescription" class="form-label" data-i18n="upload_description_label">Descri√ß√£o (opcional)</label>
                                <textarea class="form-control" id="photoDescription" name="description" rows="2"></textarea>
                            </div>
                            <div class="col-12" id="imagePreviewContainer" style="display: none;">
                                <label class="form-label" data-i18n="upload_preview_label">Preview:</label>
                                <img id="imagePreview" src="" alt="Preview" class="img-thumbnail" style="max-height: 200px;">
                            </div>
                            <div class="col-12" id="fileValidationMessage" style="display: none;">
                                <div class="alert alert-danger mb-3" role="alert">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <span id="fileValidationText"></span>
                                </div>
                            </div>
                            <div class="col-12">
                                <button type="submit" class="btn btn-success" id="submitPhotoBtn" disabled>
                                    <i class="fas fa-upload me-2"></i><span data-i18n="upload_submit_btn">Enviar Foto</span>
                                </button>
                                <button type="button" class="btn btn-secondary" id="cancelUploadBtn">
                                    <i class="fas fa-times me-2"></i><span data-i18n="upload_cancel_btn">Cancelar</span>
                                </button>
                                <div id="scrollSentinel" style="height: 1px;"></div>
                            </div>
                        </div>
                    </form>
                </div>
                {% endif %}
            </div>
            
            <!-- Rodap√© do Modal -->
            <div class="modal-footer border-0 bg-light">
                {% if current_user.is_authenticated and current_user.is_admin %}
                <button type="button" class="btn btn-success me-auto" id="toggleUploadFormBtn">
                    <i class="fas fa-plus me-2"></i><span data-i18n="upload_add_photo">Adicionar Foto</span>
                </button>
                {% endif %}
                <button type="button" class="btn btn-archaeological" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i><span data-i18n="galeria_close">Fechar</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para visualiza√ß√£o de foto individual -->
<div class="modal fade" id="photoViewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content bg-transparent border-0">
            <div class="modal-header border-0">
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0 text-center">
                <img id="photoViewImage" src="" class="img-fluid rounded" alt="" style="max-height: 85vh; object-fit: contain;">
            </div>
            <div id="photoViewInfo" class="modal-footer border-0 bg-white bg-opacity-90">
                <div class="w-100">
                    <h5 id="photoViewTitle" class="mb-2"></h5>
                    <p id="photoViewDescription" class="text-muted mb-0"></p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Add hover effects to module cards
    document.querySelectorAll('.module-card').forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-5px)';
            this.style.transition = 'transform 0.3s ease';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });
</script>

<script>
/**
 * Script para carregar e exibir a galeria da equipe no modal
 * Carrega fotos dinamicamente da API e permite visualiza√ß√£o em tela cheia
 * 
 * SISTEMA DE TRADU√á√ÉO:
 * - Todos os textos est√°ticos do template usam atributos data-i18n
 * - Elementos criados dinamicamente tamb√©m recebem data-i18n
 * - Ap√≥s criar novos elementos, I18n.updatePageContent() √© chamado
 * - Tradu√ß√µes dispon√≠veis: PT-BR, EN, ES, FR
 * - Chaves de tradu√ß√£o: gallery_*, upload_*, team_*
 */
(function() {
    'use strict';
    
    // Elementos do DOM
    const teamGalleryModal = document.getElementById('teamGalleryModal');
    const galleryLoading = document.getElementById('galleryLoading');
    const galleryGrid = document.getElementById('galleryGrid');
    const galleryEmpty = document.getElementById('galleryEmpty');
    const photoViewModal = new bootstrap.Modal(document.getElementById('photoViewModal'));
    const photoViewImage = document.getElementById('photoViewImage');
    const photoViewTitle = document.getElementById('photoViewTitle');
    const photoViewDescription = document.getElementById('photoViewDescription');
    
    // Vari√°vel para controlar se as fotos j√° foram carregadas
    let photosLoaded = false;
    
    /**
     * Carrega as fotos da galeria via API
     * @param {boolean} forceReload - Se true, for√ßa o recarregamento mesmo se j√° carregou antes
     */
    function loadGalleryPhotos(forceReload = false) {
        // Se j√° carregou e n√£o est√° for√ßando reload, n√£o carrega novamente
        if (photosLoaded && !forceReload) return;
        
        // Reseta o estado
        if (forceReload) {
            photosLoaded = false;
        }
        
        // Mostra loading
        galleryLoading.classList.remove('d-none');
        galleryGrid.classList.add('d-none');
        galleryEmpty.classList.add('d-none');
        
        // Faz requisi√ß√£o para a API
        fetch('{{ url_for("api_gallery_photos") }}')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.photos.length > 0) {
                    renderGalleryPhotos(data.photos);
                    photosLoaded = true;
                } else {
                    showEmptyState();
                }
            })
            .catch(error => {
                console.error('Erro ao carregar fotos da galeria:', error);
                showEmptyState();
            })
            .finally(() => {
                galleryLoading.classList.add('d-none');
            });
    }
    
    /**
     * Renderiza as fotos no grid
     * @param {Array} photos - Array de fotos da API
     */
    function renderGalleryPhotos(photos) {
        galleryGrid.innerHTML = '';
        
        photos.forEach(photo => {
            const photoElement = createPhotoElement(photo);
            galleryGrid.appendChild(photoElement);
        });
        
        galleryGrid.classList.remove('d-none');
        
        // Aplica tradu√ß√µes aos novos elementos
        if (window.I18n) {
            window.I18n.updatePageContent();
        }
    }
    
    /**
     * Cria um elemento de foto para o grid
     * @param {Object} photo - Dados da foto
     * @returns {HTMLElement} - Elemento div da foto
     */
    function createPhotoElement(photo) {
        const col = document.createElement('div');
        col.className = 'col-lg-4 col-md-6';
        
        const imagePath = photo.image_path.startsWith('static/') 
            ? '{{ url_for("static", filename="") }}' + photo.image_path.replace('static/', '')
            : '{{ url_for("static", filename="") }}' + photo.image_path;
        
        col.innerHTML = `
            <div class="gallery-item" data-photo-id="${photo.id}">
                <img src="${imagePath}" alt="${photo.title}" loading="lazy">
                <span class="gallery-badge">
                    <i class="fas fa-users me-1"></i><span data-i18n="gallery_team_badge">Equipe</span>
                </span>
                <div class="gallery-item-overlay">
                    <p class="gallery-item-title">${photo.title}</p>
                </div>
            </div>
        `;
        
        // Adiciona evento de clique para abrir foto em tela cheia
        const galleryItem = col.querySelector('.gallery-item');
        galleryItem.addEventListener('click', () => {
            openPhotoViewer(photo, imagePath);
        });
        
        return col;
    }
    
    /**
     * Abre o modal de visualiza√ß√£o de foto
     * @param {Object} photo - Dados da foto
     * @param {String} imagePath - Caminho da imagem
     */
    function openPhotoViewer(photo, imagePath) {
        photoViewImage.src = imagePath;
        photoViewImage.alt = photo.title;
        photoViewTitle.textContent = photo.title;
        photoViewDescription.textContent = photo.description || '';
        
        // Esconde o info se n√£o houver descri√ß√£o
        const photoViewInfo = document.getElementById('photoViewInfo');
        if (!photo.description) {
            photoViewInfo.classList.add('d-none');
        } else {
            photoViewInfo.classList.remove('d-none');
        }
        
        photoViewModal.show();
    }
    
    /**
     * Mostra o estado vazio (sem fotos)
     */
    function showEmptyState() {
        galleryGrid.classList.add('d-none');
        galleryEmpty.classList.remove('d-none');
    }
    
    /**
     * Evento quando o modal √© aberto
     * Carrega as fotos na primeira vez
     */
    if (teamGalleryModal) {
        teamGalleryModal.addEventListener('shown.bs.modal', function() {
            loadGalleryPhotos();
        });
    }
    
    // Exp√µe a fun√ß√£o de reload para uso externo (ex: ap√≥s upload de nova foto)
    window.LAARI = window.LAARI || {};
    window.LAARI.reloadGallery = function() {
        loadGalleryPhotos(true);
    };
    
    console.log('L.A.A.R.I Dashboard: Sistema de galeria da equipe carregado');
})();

{% if current_user.is_authenticated and current_user.is_admin %}
(function() {
    'use strict';
    
    const toggleUploadFormBtn = document.getElementById('toggleUploadFormBtn');
    const uploadFormContainer = document.getElementById('uploadFormContainer');
    const cancelUploadBtn = document.getElementById('cancelUploadBtn');
    const teamPhotoUploadForm = document.getElementById('teamPhotoUploadForm');
    const photoImageInput = document.getElementById('photoImage');
    const imagePreview = document.getElementById('imagePreview');
    const imagePreviewContainer = document.getElementById('imagePreviewContainer');
    const submitPhotoBtn = document.getElementById('submitPhotoBtn');
    const fileValidationMessage = document.getElementById('fileValidationMessage');
    const fileValidationText = document.getElementById('fileValidationText');
    
    // Mensagens de valida√ß√£o em m√∫ltiplos idiomas
    const validationMessages = {
        'pt-BR': {
            invalidType: 'Formato de imagem inv√°lido. Use JPG, JPEG, PNG ou GIF.',
            tooLarge: 'Arquivo muito grande. Tamanho m√°ximo: 5 MB.',
            uploadSuccess: 'Foto enviada com sucesso!',
            uploadError: 'Erro ao enviar foto. Tente novamente.'
        },
        'en': {
            invalidType: 'Invalid image format. Use JPG, JPEG, PNG or GIF.',
            tooLarge: 'File too large. Maximum size: 5 MB.',
            uploadSuccess: 'Photo uploaded successfully!',
            uploadError: 'Error uploading photo. Please try again.'
        },
        'es': {
            invalidType: 'Formato de imagen inv√°lido. Use JPG, JPEG, PNG o GIF.',
            tooLarge: 'Archivo demasiado grande. Tama√±o m√°ximo: 5 MB.',
            uploadSuccess: '¬°Foto subida con √©xito!',
            uploadError: 'Error al subir la foto. Int√©ntelo de nuevo.'
        },
        'fr': {
            invalidType: 'Format d\'image invalide. Utilisez JPG, JPEG, PNG ou GIF.',
            tooLarge: 'Fichier trop volumineux. Taille maximale: 5 Mo.',
            uploadSuccess: 'Photo t√©l√©charg√©e avec succ√®s !',
            uploadError: 'Erreur lors du t√©l√©chargement de la photo. Veuillez r√©essayer.'
        }
    };
    
    // Obt√©m o idioma atual
    function getCurrentLanguage() {
        return localStorage.getItem('selectedLanguage') || 'pt-BR';
    }
    
    // Valida o arquivo selecionado
    function validateFile(file) {
        const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
        const maxSize = 5 * 1024 * 1024; // 5MB em bytes
        const lang = getCurrentLanguage();
        const messages = validationMessages[lang] || validationMessages['pt-BR'];
        
        if (!file) {
            return { valid: false, message: '' };
        }
        
        if (!validTypes.includes(file.type)) {
            return { valid: false, message: messages.invalidType };
        }
        
        if (file.size > maxSize) {
            return { valid: false, message: messages.tooLarge };
        }
        
        return { valid: true, message: '' };
    }
    
    toggleUploadFormBtn.addEventListener('click', function() {
        uploadFormContainer.classList.toggle('d-none');
        if (!uploadFormContainer.classList.contains('d-none')) {
            // Aguarda um momento para o DOM atualizar
            setTimeout(function() {
                // Rola at√© o elemento sentinela (ap√≥s os bot√µes) para garantir visibilidade do bot√£o "Enviar Foto"
                const scrollTarget = document.getElementById('scrollSentinel');
                if (scrollTarget) {
                    scrollTarget.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'end'
                    });
                }
                // Foca no primeiro campo ap√≥s o scroll
                setTimeout(function() {
                    document.getElementById('photoTitle').focus();
                }, 400);
            }, 100);
        }
    });
    
    cancelUploadBtn.addEventListener('click', function() {
        uploadFormContainer.classList.add('d-none');
        teamPhotoUploadForm.reset();
        imagePreviewContainer.style.display = 'none';
        fileValidationMessage.style.display = 'none';
        submitPhotoBtn.disabled = true;
    });
    
    photoImageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        const validation = validateFile(file);
        
        if (!file) {
            imagePreviewContainer.style.display = 'none';
            fileValidationMessage.style.display = 'none';
            submitPhotoBtn.disabled = true;
            return;
        }
        
        if (validation.valid) {
            // Arquivo v√°lido - mostra preview e habilita bot√£o
            const reader = new FileReader();
            reader.onload = function(e) {
                imagePreview.src = e.target.result;
                imagePreviewContainer.style.display = 'block';
            };
            reader.readAsDataURL(file);
            
            fileValidationMessage.style.display = 'none';
            submitPhotoBtn.disabled = false;
        } else {
            // Arquivo inv√°lido - mostra erro e desabilita bot√£o
            imagePreviewContainer.style.display = 'none';
            fileValidationText.textContent = validation.message;
            fileValidationMessage.style.display = 'block';
            submitPhotoBtn.disabled = true;
        }
    });
    
    teamPhotoUploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;
        const lang = getCurrentLanguage();
        const messages = validationMessages[lang] || validationMessages['pt-BR'];
        
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
        if (csrfToken) {
            formData.append('csrf_token', csrfToken);
        }
        
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Enviando...';
        
        fetch('{{ url_for("upload_team_photo") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const successMessage = messages.uploadSuccess;
                if (window.LAARI && window.LAARI.showNotification) {
                    window.LAARI.showNotification(successMessage, 'success');
                } else {
                    alert(successMessage);
                }
                
                teamPhotoUploadForm.reset();
                imagePreviewContainer.style.display = 'none';
                fileValidationMessage.style.display = 'none';
                uploadFormContainer.classList.add('d-none');
                
                // Ap√≥s sucesso, bot√£o permanece desabilitado at√© novo arquivo v√°lido
                submitBtn.disabled = true;
                submitBtn.innerHTML = originalBtnText;
                
                if (window.LAARI && window.LAARI.reloadGallery) {
                    window.LAARI.reloadGallery();
                }
            } else {
                const errorMessage = data.error || messages.uploadError;
                if (window.LAARI && window.LAARI.showNotification) {
                    window.LAARI.showNotification(errorMessage, 'error');
                } else {
                    alert(errorMessage);
                }
                
                // Em caso de erro, reabilita o bot√£o para nova tentativa
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            }
        })
        .catch(error => {
            console.error('Erro ao enviar foto:', error);
            const errorMessage = messages.uploadError;
            if (window.LAARI && window.LAARI.showNotification) {
                window.LAARI.showNotification(errorMessage, 'error');
            } else {
                alert(errorMessage);
            }
            
            // Em caso de erro de rede, reabilita o bot√£o para nova tentativa
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnText;
        });
    });
})();
{% endif %}
</script>
{% endblock %}
