{% extends "base.html" %}

{% block title %}Visualizador 3D - {{ scan.artifact.name }} - L.A.A.R.I{% endblock %}

{% block head %}
<style>
    #model-container {
        width: 100%;
        height: 70vh;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        border-radius: 12px;
        overflow: hidden;
        position: relative;
    }
    
    #loading-indicator {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: #E6D2B7;
    }
    
    .model-controls {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 10px;
        background: rgba(0,0,0,0.6);
        padding: 10px 20px;
        border-radius: 25px;
    }
    
    .model-controls button {
        background: #5F3A1F;
        border: none;
        color: #E6D2B7;
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .model-controls button:hover {
        background: #E6D2B7;
        color: #5F3A1F;
    }
    
    .ai-disclaimer {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%);
        border-left: 4px solid #856404;
        padding: 15px 20px;
        margin-bottom: 20px;
        border-radius: 0 8px 8px 0;
    }
    
    .ai-disclaimer h6 {
        color: #856404;
        margin-bottom: 8px;
    }
    
    .ai-disclaimer p {
        color: #533f03;
        margin: 0;
        font-size: 0.9rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header mb-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('scanner_3d') }}">Scanner 3D</a></li>
            <li class="breadcrumb-item active">{{ scan.artifact.name }}</li>
        </ol>
    </nav>
    <h1 class="display-6 fw-bold">
        <i class="fas fa-cube me-3"></i>Visualizador 3D
    </h1>
    <p class="lead text-muted">{{ scan.artifact.name }} - {{ scan.artifact.qr_code }}</p>
</div>

{% if scan.is_ai_generated %}
<div class="ai-disclaimer">
    <h6><i class="fas fa-robot me-2"></i>Reconstrução 3D por Inteligência Artificial</h6>
    <p>Este modelo foi gerado por IA a partir de uma imagem bidimensional. Trata-se de uma reconstrução estimada, destinada a visualização e fins educacionais. Não substitui métodos científicos de escaneamento 3D profissional.</p>
</div>
{% endif %}

<div class="card border-0 shadow mb-4">
    <div class="card-body p-0">
        <div id="model-container">
            <div id="loading-indicator">
                <div class="spinner-border text-light mb-3" style="width: 3rem; height: 3rem;"></div>
                <p>Carregando modelo 3D...</p>
            </div>
        </div>
        <div class="model-controls" id="controls" style="display: none;">
            <button onclick="resetCamera()" title="Resetar câmera">
                <i class="fas fa-sync-alt me-1"></i> Resetar
            </button>
            <button onclick="toggleAutoRotate()" title="Rotação automática">
                <i class="fas fa-redo me-1"></i> Auto-Rotação
            </button>
            <button onclick="toggleWireframe()" title="Modo wireframe">
                <i class="fas fa-project-diagram me-1"></i> Wireframe
            </button>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card border-0 shadow">
            <div class="card-header bg-archaeological text-white">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Informações do Modelo</h5>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-5">Artefato:</dt>
                    <dd class="col-sm-7">{{ scan.artifact.name }}</dd>
                    
                    <dt class="col-sm-5">Código:</dt>
                    <dd class="col-sm-7">{{ scan.artifact.qr_code or '-' }}</dd>
                    
                    <dt class="col-sm-5">Tipo:</dt>
                    <dd class="col-sm-7">
                        {% if scan.is_ai_generated %}
                        <span class="badge bg-info">IA - Reconstrução Estimada</span>
                        {% else %}
                        <span class="badge bg-success">Escaneamento Profissional</span>
                        {% endif %}
                    </dd>
                    
                    <dt class="col-sm-5">Data de Criação:</dt>
                    <dd class="col-sm-7">{{ scan.scan_date.strftime('%d/%m/%Y %H:%M') }}</dd>
                    
                    {% if scan.notes %}
                    <dt class="col-sm-5">Observações:</dt>
                    <dd class="col-sm-7">{{ scan.notes }}</dd>
                    {% endif %}
                </dl>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card border-0 shadow">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-mouse-pointer me-2"></i>Controles</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2"><i class="fas fa-arrows-alt text-archaeological me-2"></i><strong>Rotação:</strong> Clique e arraste</li>
                    <li class="mb-2"><i class="fas fa-search-plus text-archaeological me-2"></i><strong>Zoom:</strong> Scroll do mouse</li>
                    <li class="mb-2"><i class="fas fa-hand-paper text-archaeological me-2"></i><strong>Pan:</strong> Clique direito e arraste</li>
                    <li><i class="fas fa-mobile-alt text-archaeological me-2"></i><strong>Touch:</strong> Um dedo rotaciona, dois dedos zoom/pan</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="mt-4">
    <a href="{{ url_for('scanner_3d') }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left me-2"></i>Voltar
    </a>
    <a href="{{ url_for('ver_artefato', id=scan.artifact.id) }}" class="btn btn-archaeological">
        <i class="fas fa-archive me-2"></i>Ver Artefato
    </a>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/loaders/GLTFLoader.js"></script>

<script>
let scene, camera, renderer, controls, model;
let isWireframe = false;
let isAutoRotate = false;

const modelUrl = "{{ scan.file_path|safe }}";

function init() {
    const container = document.getElementById('model-container');
    const width = container.clientWidth;
    const height = container.clientHeight;
    
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x1a1a2e);
    
    camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
    camera.position.set(0, 2, 5);
    
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(width, height);
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.outputEncoding = THREE.sRGBEncoding;
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = 1;
    container.appendChild(renderer.domElement);
    
    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    controls.minDistance = 1;
    controls.maxDistance = 20;
    
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
    scene.add(ambientLight);
    
    const directionalLight1 = new THREE.DirectionalLight(0xffffff, 1);
    directionalLight1.position.set(5, 10, 7);
    scene.add(directionalLight1);
    
    const directionalLight2 = new THREE.DirectionalLight(0xE6D2B7, 0.5);
    directionalLight2.position.set(-5, 5, -5);
    scene.add(directionalLight2);
    
    const gridHelper = new THREE.GridHelper(10, 10, 0x5F3A1F, 0x3d2510);
    scene.add(gridHelper);
    
    loadModel();
    
    window.addEventListener('resize', onWindowResize);
    animate();
}

function loadModel() {
    const loader = new THREE.GLTFLoader();
    
    loader.load(
        modelUrl,
        function(gltf) {
            model = gltf.scene;
            
            const box = new THREE.Box3().setFromObject(model);
            const center = box.getCenter(new THREE.Vector3());
            const size = box.getSize(new THREE.Vector3());
            
            model.position.sub(center);
            
            const maxDim = Math.max(size.x, size.y, size.z);
            const scale = 2 / maxDim;
            model.scale.multiplyScalar(scale);
            
            scene.add(model);
            
            const distance = 5;
            camera.position.set(distance, distance * 0.5, distance);
            camera.lookAt(0, 0, 0);
            controls.target.set(0, 0, 0);
            controls.update();
            
            document.getElementById('loading-indicator').style.display = 'none';
            document.getElementById('controls').style.display = 'flex';
        },
        function(xhr) {
            const percent = Math.round((xhr.loaded / xhr.total) * 100);
            document.querySelector('#loading-indicator p').textContent = 
                `Carregando modelo 3D... ${percent}%`;
        },
        function(error) {
            console.error('Error loading model:', error);
            document.getElementById('loading-indicator').innerHTML = `
                <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                <p>Erro ao carregar o modelo 3D.</p>
                <p class="small">${error.message || 'Verifique se o arquivo está acessível.'}</p>
            `;
        }
    );
}

function onWindowResize() {
    const container = document.getElementById('model-container');
    const width = container.clientWidth;
    const height = container.clientHeight;
    
    camera.aspect = width / height;
    camera.updateProjectionMatrix();
    renderer.setSize(width, height);
}

function animate() {
    requestAnimationFrame(animate);
    
    if (isAutoRotate && model) {
        model.rotation.y += 0.005;
    }
    
    controls.update();
    renderer.render(scene, camera);
}

function resetCamera() {
    camera.position.set(5, 2.5, 5);
    camera.lookAt(0, 0, 0);
    controls.target.set(0, 0, 0);
    controls.update();
    
    if (model) {
        model.rotation.set(0, 0, 0);
    }
}

function toggleAutoRotate() {
    isAutoRotate = !isAutoRotate;
    event.target.closest('button').classList.toggle('active', isAutoRotate);
}

function toggleWireframe() {
    isWireframe = !isWireframe;
    
    if (model) {
        model.traverse(function(child) {
            if (child.isMesh) {
                child.material.wireframe = isWireframe;
            }
        });
    }
    
    event.target.closest('button').classList.toggle('active', isWireframe);
}

document.addEventListener('DOMContentLoaded', init);
</script>
{% endblock %}
